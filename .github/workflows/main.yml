name: Generate Social Media Feed

on: [push]
  branches:
    - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install Poetry
        run: curl -sSL https://install.python-poetry.org | python3 -

      - name: Add Poetry to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install Dependencies
        run: |
          # use in-project virtualenv
          poetry config virtualenvs.in-project true
          # regenerate lock file if out of sync
          poetry lock || true
          poetry install --no-root

      - name: Run Uvicorn server in background
        run: |
          source .venv/bin/activate
          uvicorn app:app --host 0.0.0.0 --port 8000 &
          sleep 5

      # Optional: Verify application is running
      # - name: Verify application
      #   run: |
      #     curl -f http://127.0.0.1:8000/ || exit 1

      - name: Push Repo
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "Modify Feed" || echo "No changes to commit"
          git push || echo "Nothing to push"
